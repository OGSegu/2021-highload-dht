# Этап 2. Многопоточность

## Нагрузочное тестирование

Проведем нагрузочное тестирование с помощью wrk2. В качестве параметров возьмем следующие значения:
* **16 соединение**
* 1 поток
* 30 секунд
* 20000 RPS

**Выполним тестирование PUT запросам**, содержимое которого, описано в скрипте [put.lua](../hw1/scripts/put.lua)
```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s put.lua http://localhost:8080
```

Результаты:
```bash
  1 threads and 16 connections
  Thread calibration: mean lat.: 1.419ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.40ms  631.80us   9.47ms   66.52%
    Req/Sec     3.52k     4.52k   13.44k    71.22%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.33ms
 75.000%    1.84ms
 90.000%    2.26ms
 99.000%    2.78ms
 99.900%    3.82ms
 99.990%    8.31ms
 99.999%    9.06ms
100.000%    9.48ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       0.615     0.100000         6637         1.11
       0.838     0.200000        13240         1.25
       1.004     0.300000        19859         1.43
       1.163     0.400000        26498         1.67
       1.334     0.500000        33122         2.00
       1.425     0.550000        36417         2.22
       1.523     0.600000        39724         2.50
       1.628     0.650000        43053         2.86
       1.734     0.700000        46349         3.33
       1.840     0.750000        49650         4.00
       1.897     0.775000        51307         4.44
       1.957     0.800000        52976         5.00
       2.023     0.825000        54614         5.71
       2.095     0.850000        56300         6.67
       2.169     0.875000        57940         8.00
       2.211     0.887500        58784         8.89
       2.255     0.900000        59587        10.00
       2.301     0.912500        60433        11.43
       2.347     0.925000        61251        13.33
       2.403     0.937500        62068        16.00
       2.433     0.943750        62499        17.78
       2.463     0.950000        62897        20.00
       2.495     0.956250        63308        22.86
       2.529     0.962500        63716        26.67
       2.567     0.968750        64146        32.00
       2.589     0.971875        64347        35.56
       2.611     0.975000        64543        40.00
       2.637     0.978125        64751        45.71
       2.667     0.981250        64955        53.33
       2.701     0.984375        65170        64.00
       2.719     0.985938        65270        71.11
       2.739     0.987500        65370        80.00
       2.761     0.989062        65473        91.43
       2.785     0.990625        65581       106.67
       2.813     0.992188        65678       128.00
       2.833     0.992969        65732       142.22
       2.855     0.993750        65785       160.00
       2.877     0.994531        65836       182.86
       2.913     0.995313        65887       213.33
       2.951     0.996094        65937       256.00
       2.965     0.996484        65963       284.44
       2.985     0.996875        65990       320.00
       3.005     0.997266        66015       365.71
       3.049     0.997656        66042       426.67
       3.105     0.998047        66067       512.00
       3.145     0.998242        66080       568.89
       3.179     0.998437        66092       640.00
       3.269     0.998633        66106       731.43
       3.441     0.998828        66118       853.33
       4.079     0.999023        66131      1024.00
       4.495     0.999121        66137      1137.78
       4.871     0.999219        66144      1280.00
       5.471     0.999316        66150      1462.86
       5.887     0.999414        66157      1706.67
       6.111     0.999512        66163      2048.00
       6.615     0.999561        66166      2275.56
       6.859     0.999609        66170      2560.00
       7.139     0.999658        66173      2925.71
       7.179     0.999707        66176      3413.33
       7.319     0.999756        66179      4096.00
       7.679     0.999780        66181      4551.11
       7.899     0.999805        66183      5120.00
       7.919     0.999829        66184      5851.43
       7.979     0.999854        66186      6826.67
       8.039     0.999878        66187      8192.00
       8.311     0.999890        66189      9102.22
       8.311     0.999902        66189     10240.00
       8.343     0.999915        66190     11702.86
       8.415     0.999927        66191     13653.33
       8.415     0.999939        66191     16384.00
       8.471     0.999945        66192     18204.44
       8.471     0.999951        66192     20480.00
       8.495     0.999957        66193     23405.71
       8.495     0.999963        66193     27306.67
       8.495     0.999969        66193     32768.00
       9.063     0.999973        66194     36408.89
       9.063     0.999976        66194     40960.00
       9.063     0.999979        66194     46811.43
       9.063     0.999982        66194     54613.33
       9.063     0.999985        66194     65536.00
       9.479     0.999986        66195     72817.78
       9.479     1.000000        66195          inf
#[Mean    =        1.396, StdDeviation   =        0.632]
#[Max     =        9.472, Total count    =        66195]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  166601 requests in 30.00s, 10.65MB read
  Socket errors: connect 0, read 0, write 0, timeout 90
Requests/sec:   5553.31
Transfer/sec:    363.35KB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.33мс
* "Хвостовые" время ожидания (p999, p9999, p99999) = 3.82мс, 8.31мс, 9.06мс, 9.48мс соответственно

На данном этапе мы выполняли нагрузочное тестирование в 16 соединений и как мы можем заметить по
персентилям, нам удалось перенести "переход" с p99 на p999. А так же наш сервер способен стабильно и корректно обрабатывать
больше 1 соединения. Получить более подробную картину оптимизаций будет возможно при помощи профилирования.

**Выполним тестирование GET запросом**, содержимое которого, описано в скрипте [get.lua](../hw1/scripts/get.lua)

Будут использованы аналогичные хар-ки, как и в случае с PUT запросом.
Наша БД предварительно заполнена более чем на 300к+ записей

```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s get.lua http://localhost:8080
```

Результаты:
```bash
  1 threads and 16 connections
  Thread calibration: mean lat.: 1.170ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.23ms  523.02us   3.09ms   63.91%
    Req/Sec     3.31k   259.06     4.00k    73.02%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.20ms
 75.000%    1.61ms
 90.000%    1.94ms
 99.000%    2.42ms
 99.900%    2.77ms
 99.990%    3.03ms
 99.999%    3.09ms
100.000%    3.09ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.078     0.000000            1         1.00
       0.560     0.100000         6228         1.11
       0.733     0.200000        12477         1.25
       0.883     0.300000        18706         1.43
       1.033     0.400000        24904         1.67
       1.198     0.500000        31157         2.00
       1.278     0.550000        34250         2.22
       1.362     0.600000        37355         2.50
       1.443     0.650000        40476         2.86
       1.524     0.700000        43579         3.33
       1.612     0.750000        46717         4.00
       1.658     0.775000        48268         4.44
       1.709     0.800000        49803         5.00
       1.763     0.825000        51359         5.71
       1.817     0.850000        52923         6.67
       1.876     0.875000        54476         8.00
       1.905     0.887500        55270         8.89
       1.940     0.900000        56045        10.00
       1.972     0.912500        56817        11.43
       2.011     0.925000        57586        13.33
       2.057     0.937500        58391        16.00
       2.081     0.943750        58767        17.78
       2.109     0.950000        59172        20.00
       2.137     0.956250        59535        22.86
       2.169     0.962500        59938        26.67
       2.201     0.968750        60309        32.00
       2.221     0.971875        60512        35.56
       2.243     0.975000        60713        40.00
       2.267     0.978125        60902        45.71
       2.295     0.981250        61090        53.33
       2.333     0.984375        61282        64.00
       2.351     0.985938        61378        71.11
       2.377     0.987500        61474        80.00
       2.403     0.989062        61572        91.43
       2.435     0.990625        61667       106.67
       2.471     0.992188        61767       128.00
       2.485     0.992969        61820       142.22
       2.499     0.993750        61866       160.00
       2.521     0.994531        61913       182.86
       2.541     0.995313        61961       213.33
       2.577     0.996094        62009       256.00
       2.603     0.996484        62037       284.44
       2.625     0.996875        62058       320.00
       2.645     0.997266        62080       365.71
       2.671     0.997656        62108       426.67
       2.701     0.998047        62129       512.00
       2.717     0.998242        62142       568.89
       2.725     0.998437        62153       640.00
       2.737     0.998633        62165       731.43
       2.755     0.998828        62179       853.33
       2.771     0.999023        62190      1024.00
       2.781     0.999121        62196      1137.78
       2.787     0.999219        62202      1280.00
       2.793     0.999316        62208      1462.86
       2.801     0.999414        62215      1706.67
       2.811     0.999512        62220      2048.00
       2.831     0.999561        62223      2275.56
       2.849     0.999609        62226      2560.00
       2.857     0.999658        62229      2925.71
       2.889     0.999707        62232      3413.33
       2.937     0.999756        62235      4096.00
       2.947     0.999780        62237      4551.11
       2.949     0.999805        62238      5120.00
       2.963     0.999829        62240      5851.43
       2.975     0.999854        62241      6826.67
       2.997     0.999878        62243      8192.00
       3.029     0.999890        62244      9102.22
       3.029     0.999902        62244     10240.00
       3.035     0.999915        62245     11702.86
       3.047     0.999927        62246     13653.33
       3.063     0.999939        62247     16384.00
       3.063     0.999945        62247     18204.44
       3.063     0.999951        62247     20480.00
       3.073     0.999957        62248     23405.71
       3.073     0.999963        62248     27306.67
       3.085     0.999969        62249     32768.00
       3.085     0.999973        62249     36408.89
       3.085     0.999976        62249     40960.00
       3.085     0.999979        62249     46811.43
       3.085     0.999982        62249     54613.33
       3.087     0.999985        62250     65536.00
       3.087     1.000000        62250          inf
#[Mean    =        1.225, StdDeviation   =        0.523]
#[Max     =        3.086, Total count    =        62250]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  93666 requests in 30.00s, 6.50MB read
  Socket errors: connect 0, read 0, write 0, timeout 154
Requests/sec:   3122.20
Transfer/sec:    221.89KB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.20мс
* "Хвостовые" время ожидания (p999, p9999, p99999) = 3.03мс, 3.09мс, 3.09мс соответственно

В нашей реализации БД - операция GET потокобезопасна. Поэтому никаких новоизмененный в персентилях ожидать не стоит

## Профилирование

Проведем профилирование путем использования библиотеки async-profiler. Обсуловимся выполнять этап
параллельно с нагрузочным тестированием со следующими хар-ки:
* 16 соединений
* 1 поток
* 10000 RPS

Для GET запросов - БД наполнена

Для async-profiler:
* 30 секунд


### Результат профилирования по CPU на вставку данных

[Click me](profiling/cpuput.html)  

Заметим, что теперь операция flush находится в отдельном столбце у корня которого находится, Thread.run,
связанно это с тем, что flush вызывается в отдельном потоке, что бы не блокировать сервер. Вспомним, что
на прошлом стейдже операция занимала у нас 43% времени работы программы, теперь имеем 14,87% и возможность
обрабатывать больше запросов за меньший latency.

### Результат профилирования по CPU на получение данных:

[Click me](profiling/cpuget.html)  

Функциональные составляющие получения данных из БД занимают очевидно кол-во программного времени.
Можно привести аналогичный анализ как и в первом стейдже. Единственным отличием будет добавление мерджа
итераторов в списке предназначенных для флаша.

### Результат профилирования по Allocation на получение данных:

[Click me](profiling/allocget.html)

Получаем схожую картину как и в прошлом стейдже, что и стоило ожидать

### Результат профилирования по Allocation на вставку данных:

[Click me](profiling/allocput.html)

В данном графе можно заметить, новый столбец, который обознает аллокации в нашем ExecutorService, картина
вполне ожидаемая, на аллокацию во флаше приходится 2,5% программного времени

### Результат профилирования по Lock на вставку данных:
[Click me](profiling/lockput.html)

Локи отсутсвуют.

### Результат профилирования по Lock на получение данных:
[Click me](profiling/lockget.html)

Локи отсутствуют.







