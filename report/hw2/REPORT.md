# Этап 2. Многопоточность

## Нагрузочное тестирование

Проведем нагрузочное тестирование с помощью wrk2. В качестве параметров возьмем следующие значения:
* **16 соединение**
* 1 поток
* 30 секунд
* 20000 RPS

**Выполним тестирование PUT запросам**, содержимое которого, описано в скрипте [put.lua](../hw1/scripts/put.lua)
```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s put.lua http://localhost:8080
```

Результаты:
```bash
Running 30s test @ http://localhost:8080
  1 threads and 16 connections
  Thread calibration: mean lat.: 1.069ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.04ms  642.06us  12.83ms   72.25%
    Req/Sec    21.00k     1.40k   35.00k    83.86%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.00ms
 75.000%    1.38ms
 90.000%    1.80ms
 99.000%    2.26ms
 99.900%    7.17ms
 99.990%    9.69ms
 99.999%   11.89ms
100.000%   12.84ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.016     0.000000            1         1.00
       0.307     0.100000        39875         1.11
       0.519     0.200000        79830         1.25
       0.716     0.300000       119556         1.43
       0.863     0.400000       159602         1.67
       1.003     0.500000       199392         2.00
       1.090     0.550000       219385         2.22
       1.162     0.600000       239088         2.50
       1.222     0.650000       259054         2.86
       1.284     0.700000       279084         3.33
       1.382     0.750000       298853         4.00
       1.448     0.775000       308759         4.44
       1.513     0.800000       318808         5.00
       1.574     0.825000       328761         5.71
       1.643     0.850000       338669         6.67
       1.731     0.875000       348614         8.00
       1.768     0.887500       353579         8.89
       1.799     0.900000       358559        10.00
       1.829     0.912500       363655        11.43
       1.857     0.925000       368646        13.33
       1.885     0.937500       373594        16.00
       1.900     0.943750       376051        17.78
       1.916     0.950000       378650        20.00
       1.931     0.956250       380984        22.86
       1.949     0.962500       383524        26.67
       1.970     0.968750       386025        32.00
       1.982     0.971875       387273        35.56
       1.995     0.975000       388463        40.00
       2.011     0.978125       389682        45.71
       2.032     0.981250       390968        53.33
       2.063     0.984375       392196        64.00
       2.085     0.985938       392795        71.11
       2.119     0.987500       393435        80.00
       2.183     0.989062       394056        91.43
       2.331     0.990625       394662       106.67
       2.621     0.992188       395284       128.00
       2.849     0.992969       395595       142.22
       3.165     0.993750       395907       160.00
       3.527     0.994531       396218       182.86
       3.957     0.995313       396530       213.33
       4.447     0.996094       396840       256.00
       4.707     0.996484       396998       284.44
       4.987     0.996875       397153       320.00
       5.255     0.997266       397307       365.71
       5.587     0.997656       397464       426.67
       5.895     0.998047       397619       512.00
       6.159     0.998242       397698       568.89
       6.391     0.998437       397774       640.00
       6.619     0.998633       397852       731.43
       6.927     0.998828       397930       853.33
       7.211     0.999023       398007      1024.00
       7.359     0.999121       398046      1137.78
       7.575     0.999219       398085      1280.00
       7.751     0.999316       398124      1462.86
       7.987     0.999414       398163      1706.67
       8.231     0.999512       398204      2048.00
       8.359     0.999561       398221      2275.56
       8.495     0.999609       398243      2560.00
       8.687     0.999658       398260      2925.71
       8.847     0.999707       398280      3413.33
       8.991     0.999756       398299      4096.00
       9.095     0.999780       398310      4551.11
       9.287     0.999805       398319      5120.00
       9.391     0.999829       398328      5851.43
       9.519     0.999854       398339      6826.67
       9.607     0.999878       398348      8192.00
       9.655     0.999890       398353      9102.22
       9.775     0.999902       398358     10240.00
       9.847     0.999915       398362     11702.86
      10.047     0.999927       398367     13653.33
      10.143     0.999939       398372     16384.00
      10.255     0.999945       398375     18204.44
      10.359     0.999951       398377     20480.00
      10.599     0.999957       398379     23405.71
      10.751     0.999963       398382     27306.67
      10.927     0.999969       398384     32768.00
      11.119     0.999973       398386     36408.89
      11.295     0.999976       398387     40960.00
      11.343     0.999979       398388     46811.43
      11.479     0.999982       398389     54613.33
      11.663     0.999985       398390     65536.00
      11.743     0.999986       398391     72817.78
      11.887     0.999988       398392     81920.00
      11.887     0.999989       398392     93622.86
      12.087     0.999991       398393    109226.67
      12.087     0.999992       398393    131072.00
      12.135     0.999993       398394    145635.56
      12.135     0.999994       398394    163840.00
      12.135     0.999995       398394    187245.71
      12.487     0.999995       398395    218453.33
      12.487     0.999996       398395    262144.00
      12.487     0.999997       398395    291271.11
      12.487     0.999997       398395    327680.00
      12.487     0.999997       398395    374491.43
      12.839     0.999998       398396    436906.67
      12.839     1.000000       398396          inf
#[Mean    =        1.042, StdDeviation   =        0.642]
#[Max     =       12.832, Total count    =       398396]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599246 requests in 30.00s, 38.29MB read
Requests/sec:  19974.71
Transfer/sec:      1.28MB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.00мс
* "Хвостовые" время ожидания (p99, p999, p9999, p99999) = 2.26мс, 7.17мс, 11.89мс соответственно

На данном этапе мы выполняли нагрузочное тестирование в 16 соединений и как мы можем заметить по
персентилям, нам удалось перенести "переход" с p99 на p999. А так же наш сервер способен стабильно и корректно обрабатывать
больше 1 соединения. Получить более подробную картину оптимизаций будет возможно при помощи профилирования.

**Выполним тестирование GET запросом**, содержимое которого, описано в скрипте [get.lua](../hw1/scripts/get.lua)

Будут использованы аналогичные хар-ки, как и в случае с PUT запросом.
Наша БД предварительно заполнена более чем на 300к+ записей

```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s get.lua http://localhost:8080
```

Результаты:
```bash
 Running 30s test @ http://localhost:8080
  1 threads and 16 connections
  Thread calibration: mean lat.: 1.073ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.06ms  560.02us  11.52ms   66.21%
    Req/Sec    20.64k     1.17k   31.20k    75.48%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.41ms
 90.000%    1.82ms
 99.000%    2.15ms
 99.900%    4.10ms
 99.990%    9.16ms
 99.999%   10.90ms
100.000%   11.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.019     0.000000            1         1.00
       0.323     0.100000        39865         1.11
       0.556     0.200000        79809         1.25
       0.734     0.300000       119574         1.43
       0.895     0.400000       159373         1.67
       1.032     0.500000       199273         2.00
       1.106     0.550000       219380         2.22
       1.182     0.600000       239269         2.50
       1.253     0.650000       259205         2.86
       1.323     0.700000       279097         3.33
       1.414     0.750000       298918         4.00
       1.474     0.775000       308802         4.44
       1.540     0.800000       318797         5.00
       1.606     0.825000       328686         5.71
       1.675     0.850000       338689         6.67
       1.746     0.875000       348679         8.00
       1.783     0.887500       353672         8.89
       1.819     0.900000       358618        10.00
       1.856     0.912500       363689        11.43
       1.890     0.925000       368597        13.33
       1.924     0.937500       373522        16.00
       1.941     0.943750       376048        17.78
       1.959     0.950000       378539        20.00
       1.978     0.956250       381041        22.86
       1.998     0.962500       383563        26.67
       2.019     0.968750       386003        32.00
       2.031     0.971875       387253        35.56
       2.044     0.975000       388484        40.00
       2.059     0.978125       389764        45.71
       2.075     0.981250       390990        53.33
       2.095     0.984375       392279        64.00
       2.107     0.985938       392883        71.11
       2.119     0.987500       393472        80.00
       2.135     0.989062       394060        91.43
       2.157     0.990625       394696       106.67
       2.185     0.992188       395332       128.00
       2.203     0.992969       395639       142.22
       2.223     0.993750       395923       160.00
       2.255     0.994531       396242       182.86
       2.297     0.995313       396550       213.33
       2.359     0.996094       396856       256.00
       2.409     0.996484       397008       284.44
       2.471     0.996875       397161       320.00
       2.583     0.997266       397321       365.71
       2.785     0.997656       397473       426.67
       3.041     0.998047       397628       512.00
       3.175     0.998242       397706       568.89
       3.407     0.998437       397787       640.00
       3.635     0.998633       397862       731.43
       3.843     0.998828       397942       853.33
       4.159     0.999023       398017      1024.00
       4.335     0.999121       398056      1137.78
       4.511     0.999219       398095      1280.00
       4.667     0.999316       398135      1462.86
       4.971     0.999414       398173      1706.67
       5.279     0.999512       398213      2048.00
       5.391     0.999561       398231      2275.56
       5.671     0.999609       398251      2560.00
       5.919     0.999658       398270      2925.71
       6.323     0.999707       398290      3413.33
       6.787     0.999756       398309      4096.00
       7.191     0.999780       398319      4551.11
       7.491     0.999805       398330      5120.00
       7.863     0.999829       398338      5851.43
       8.287     0.999854       398348      6826.67
       8.823     0.999878       398358      8192.00
       8.967     0.999890       398363      9102.22
       9.383     0.999902       398368     10240.00
       9.511     0.999915       398372     11702.86
       9.663     0.999927       398377     13653.33
       9.903     0.999939       398382     16384.00
      10.199     0.999945       398385     18204.44
      10.223     0.999951       398387     20480.00
      10.263     0.999957       398389     23405.71
      10.343     0.999963       398392     27306.67
      10.351     0.999969       398394     32768.00
      10.687     0.999973       398396     36408.89
      10.695     0.999976       398397     40960.00
      10.807     0.999979       398400     46811.43
      10.807     0.999982       398400     54613.33
      10.807     0.999985       398400     65536.00
      10.839     0.999986       398401     72817.78
      10.895     0.999988       398403     81920.00
      10.895     0.999989       398403     93622.86
      10.895     0.999991       398403    109226.67
      10.895     0.999992       398403    131072.00
      10.911     0.999993       398404    145635.56
      10.911     0.999994       398404    163840.00
      10.911     0.999995       398404    187245.71
      10.983     0.999995       398405    218453.33
      10.983     0.999996       398405    262144.00
      10.983     0.999997       398405    291271.11
      10.983     0.999997       398405    327680.00
      10.983     0.999997       398405    374491.43
      11.527     0.999998       398406    436906.67
      11.527     1.000000       398406          inf
#[Mean    =        1.056, StdDeviation   =        0.560]
#[Max     =       11.520, Total count    =       398406]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599245 requests in 30.00s, 42.17MB read
Requests/sec:  19974.70
Transfer/sec:      1.41MB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.00мс
* "Хвостовые" время ожидания (p99, p999, p9999, p99999) = 2.15мс, 4.10мс, 9.16мс, 10.90мс соответственно

В нашей реализации БД - операция GET потокобезопасна. Поэтому никаких новоизмененный в персентилях ожидать не стоит

## Профилирование

Проведем профилирование путем использования библиотеки async-profiler. Обсуловимся выполнять этап
параллельно с нагрузочным тестированием со следующими хар-ки:
* 16 соединений
* 1 поток
* 30 секунд
* 20000 RPS

Для GET запросов - БД наполнена

Для async-profiler:
* 30 секунд


### Результат профилирования по CPU на вставку данных

[Click me](profiling/putCpu.html)  

Заметим, что теперь операция flush находится в отдельном столбце у корня которого находится, Thread.run,
связанно это с тем, что flush вызывается в отдельном потоке, что бы не блокировать сервер. Вспомним, что
на прошлом стейдже операция занимала у нас 43% времени работы программы, теперь имеем 26%, возможность
обрабатывать больше запросов за меньший latency. Также интерес представляют несколько операций записи, которые
по своей сущности делают системный вызов. Эта часть будет оптимизирована мною в следующем стейдже.

### Результат профилирования по CPU на получение данных:

[Click me](profiling/getCpu.html)  

Функциональные составляющие получения данных из БД занимают очевидно кол-во программного времени.
Можно привести аналогичный анализ как и в первом стейдже

### Результат профилирования по Allocation на получение данных:

[Click me](profiling/getAlloc.html)

Получаем схожую картину как и в прошлом стейдже,что и стоило ожидать

### Результат профилирования по Allocation на вставку данных:

[Click me](profiling/putAlloc.html)

В данном графе можно заметить, новый столбец, который обознает аллокации в нашем ExecutorService, картина
вполне ожидаемая,на аллокацию во флаше приходится 4% программного времени




