# Этап 2. Многопоточность

## Нагрузочное тестирование

Проведем нагрузочное тестирование с помощью wrk2. В качестве параметров возьмем следующие значения:
* **16 соединение**
* 1 поток
* 30 секунд
* 20000 RPS

**Выполним тестирование PUT запросам**, содержимое которого, описано в скрипте [put.lua](../hw1/scripts/put.lua)
```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s put.lua http://localhost:8080
```

Результаты:
```bash
Running 30s test @ http://localhost:8080
  1 threads and 16 connections
  Thread calibration: mean lat.: 0.857ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   821.70us  589.37us  17.20ms   91.83%
    Req/Sec     8.76k     1.18k   19.22k    71.74%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  788.00us
 75.000%    1.11ms
 90.000%    1.31ms
 99.000%    1.56ms
 99.900%    9.34ms
 99.990%   15.34ms
 99.999%   16.69ms
100.000%   17.22ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.024     0.000000            1         1.00
       0.302     0.100000        16507         1.11
       0.423     0.200000        32803         1.25
       0.547     0.300000        49168         1.43
       0.669     0.400000        65564         1.67
       0.788     0.500000        81870         2.00
       0.851     0.550000        90058         2.22
       0.912     0.600000        98239         2.50
       0.977     0.650000       106503         2.86
       1.043     0.700000       114644         3.33
       1.109     0.750000       122820         4.00
       1.141     0.775000       126916         4.44
       1.172     0.800000       131112         5.00
       1.203     0.825000       135169         5.71
       1.235     0.850000       139281         6.67
       1.270     0.875000       143345         8.00
       1.288     0.887500       145336         8.89
       1.306     0.900000       147370        10.00
       1.324     0.912500       149436        11.43
       1.342     0.925000       151450        13.33
       1.362     0.937500       153543        16.00
       1.372     0.943750       154628        17.78
       1.382     0.950000       155559        20.00
       1.395     0.956250       156615        22.86
       1.409     0.962500       157627        26.67
       1.426     0.968750       158619        32.00
       1.437     0.971875       159159        35.56
       1.448     0.975000       159647        40.00
       1.463     0.978125       160160        45.71
       1.478     0.981250       160670        53.33
       1.498     0.984375       161191        64.00
       1.511     0.985938       161437        71.11
       1.527     0.987500       161684        80.00
       1.548     0.989062       161944        91.43
       1.571     0.990625       162197       106.67
       1.608     0.992188       162451       128.00
       1.633     0.992969       162579       142.22
       1.674     0.993750       162706       160.00
       1.745     0.994531       162834       182.86
       2.013     0.995313       162962       213.33
       2.783     0.996094       163092       256.00
       3.193     0.996484       163154       284.44
       3.779     0.996875       163218       320.00
       4.571     0.997266       163282       365.71
       5.307     0.997656       163346       426.67
       6.191     0.998047       163410       512.00
       6.647     0.998242       163442       568.89
       7.279     0.998437       163474       640.00
       7.963     0.998633       163506       731.43
       8.703     0.998828       163538       853.33
       9.543     0.999023       163570      1024.00
      10.055     0.999121       163586      1137.78
      10.471     0.999219       163602      1280.00
      11.127     0.999316       163618      1462.86
      11.655     0.999414       163634      1706.67
      12.303     0.999512       163650      2048.00
      12.743     0.999561       163658      2275.56
      13.015     0.999609       163666      2560.00
      13.327     0.999658       163674      2925.71
      13.751     0.999707       163682      3413.33
      14.159     0.999756       163690      4096.00
      14.375     0.999780       163694      4551.11
      14.559     0.999805       163698      5120.00
      14.639     0.999829       163702      5851.43
      14.887     0.999854       163706      6826.67
      15.207     0.999878       163710      8192.00
      15.247     0.999890       163712      9102.22
      15.471     0.999902       163714     10240.00
      15.719     0.999915       163716     11702.86
      15.815     0.999927       163718     13653.33
      15.863     0.999939       163720     16384.00
      16.063     0.999945       163721     18204.44
      16.103     0.999951       163723     20480.00
      16.103     0.999957       163723     23405.71
      16.479     0.999963       163724     27306.67
      16.511     0.999969       163725     32768.00
      16.511     0.999973       163725     36408.89
      16.559     0.999976       163726     40960.00
      16.559     0.999979       163726     46811.43
      16.687     0.999982       163727     54613.33
      16.687     0.999985       163727     65536.00
      16.687     0.999986       163727     72817.78
      16.959     0.999988       163728     81920.00
      16.959     0.999989       163728     93622.86
      16.959     0.999991       163728    109226.67
      16.959     0.999992       163728    131072.00
      16.959     0.999993       163728    145635.56
      17.215     0.999994       163729    163840.00
      17.215     1.000000       163729          inf
#[Mean    =        0.822, StdDeviation   =        0.589]
#[Max     =       17.200, Total count    =       163729]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  264158 requests in 30.00s, 16.88MB read
  Socket errors: connect 0, read 0, write 0, timeout 24
Requests/sec:   8805.07
Transfer/sec:    576.11KB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 780нс
* "Хвостовые" время ожидания (p99, p999, p9999, p99999) = 1.56мс, 9.34мс, 15.34мс, 16.69с соответственно

На данном этапе мы выполняли нагрузочное тестирование в 16 соединений и как мы можем заметить по
персентилям, нам удалось перенести "переход" с p99 на p999. А так же наш сервер способен стабильно и корректно обрабатывать
больше 1 соединения. Получить более подробную картину оптимизаций будет возможно при помощи профилирования.

**Выполним тестирование GET запросом**, содержимое которого, описано в скрипте [get.lua](../hw1/scripts/get.lua)

Будут использованы аналогичные хар-ки, как и в случае с PUT запросом.
Наша БД предварительно заполнена более чем на 300к+ записей

```bash
wrk2 -c 16 -t 1 -d 30s -R 20000 --latency -s get.lua http://localhost:8080
```

Результаты:
```bash
 Running 30s test @ http://localhost:8080
  1 threads and 16 connections
  Thread calibration: mean lat.: 1.073ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.06ms  560.02us  11.52ms   66.21%
    Req/Sec    20.64k     1.17k   31.20k    75.48%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.41ms
 90.000%    1.82ms
 99.000%    2.15ms
 99.900%    4.10ms
 99.990%    9.16ms
 99.999%   10.90ms
100.000%   11.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.019     0.000000            1         1.00
       0.323     0.100000        39865         1.11
       0.556     0.200000        79809         1.25
       0.734     0.300000       119574         1.43
       0.895     0.400000       159373         1.67
       1.032     0.500000       199273         2.00
       1.106     0.550000       219380         2.22
       1.182     0.600000       239269         2.50
       1.253     0.650000       259205         2.86
       1.323     0.700000       279097         3.33
       1.414     0.750000       298918         4.00
       1.474     0.775000       308802         4.44
       1.540     0.800000       318797         5.00
       1.606     0.825000       328686         5.71
       1.675     0.850000       338689         6.67
       1.746     0.875000       348679         8.00
       1.783     0.887500       353672         8.89
       1.819     0.900000       358618        10.00
       1.856     0.912500       363689        11.43
       1.890     0.925000       368597        13.33
       1.924     0.937500       373522        16.00
       1.941     0.943750       376048        17.78
       1.959     0.950000       378539        20.00
       1.978     0.956250       381041        22.86
       1.998     0.962500       383563        26.67
       2.019     0.968750       386003        32.00
       2.031     0.971875       387253        35.56
       2.044     0.975000       388484        40.00
       2.059     0.978125       389764        45.71
       2.075     0.981250       390990        53.33
       2.095     0.984375       392279        64.00
       2.107     0.985938       392883        71.11
       2.119     0.987500       393472        80.00
       2.135     0.989062       394060        91.43
       2.157     0.990625       394696       106.67
       2.185     0.992188       395332       128.00
       2.203     0.992969       395639       142.22
       2.223     0.993750       395923       160.00
       2.255     0.994531       396242       182.86
       2.297     0.995313       396550       213.33
       2.359     0.996094       396856       256.00
       2.409     0.996484       397008       284.44
       2.471     0.996875       397161       320.00
       2.583     0.997266       397321       365.71
       2.785     0.997656       397473       426.67
       3.041     0.998047       397628       512.00
       3.175     0.998242       397706       568.89
       3.407     0.998437       397787       640.00
       3.635     0.998633       397862       731.43
       3.843     0.998828       397942       853.33
       4.159     0.999023       398017      1024.00
       4.335     0.999121       398056      1137.78
       4.511     0.999219       398095      1280.00
       4.667     0.999316       398135      1462.86
       4.971     0.999414       398173      1706.67
       5.279     0.999512       398213      2048.00
       5.391     0.999561       398231      2275.56
       5.671     0.999609       398251      2560.00
       5.919     0.999658       398270      2925.71
       6.323     0.999707       398290      3413.33
       6.787     0.999756       398309      4096.00
       7.191     0.999780       398319      4551.11
       7.491     0.999805       398330      5120.00
       7.863     0.999829       398338      5851.43
       8.287     0.999854       398348      6826.67
       8.823     0.999878       398358      8192.00
       8.967     0.999890       398363      9102.22
       9.383     0.999902       398368     10240.00
       9.511     0.999915       398372     11702.86
       9.663     0.999927       398377     13653.33
       9.903     0.999939       398382     16384.00
      10.199     0.999945       398385     18204.44
      10.223     0.999951       398387     20480.00
      10.263     0.999957       398389     23405.71
      10.343     0.999963       398392     27306.67
      10.351     0.999969       398394     32768.00
      10.687     0.999973       398396     36408.89
      10.695     0.999976       398397     40960.00
      10.807     0.999979       398400     46811.43
      10.807     0.999982       398400     54613.33
      10.807     0.999985       398400     65536.00
      10.839     0.999986       398401     72817.78
      10.895     0.999988       398403     81920.00
      10.895     0.999989       398403     93622.86
      10.895     0.999991       398403    109226.67
      10.895     0.999992       398403    131072.00
      10.911     0.999993       398404    145635.56
      10.911     0.999994       398404    163840.00
      10.911     0.999995       398404    187245.71
      10.983     0.999995       398405    218453.33
      10.983     0.999996       398405    262144.00
      10.983     0.999997       398405    291271.11
      10.983     0.999997       398405    327680.00
      10.983     0.999997       398405    374491.43
      11.527     0.999998       398406    436906.67
      11.527     1.000000       398406          inf
#[Mean    =        1.056, StdDeviation   =        0.560]
#[Max     =       11.520, Total count    =       398406]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599245 requests in 30.00s, 42.17MB read
Requests/sec:  19974.70
Transfer/sec:      1.41MB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.00мс
* "Хвостовые" время ожидания (p99, p999, p9999, p99999) = 2.15мс, 4.10мс, 9.16мс, 10.90мс соответственно

В нашей реализации БД - операция GET потокобезопасна. Поэтому никаких новоизмененный в персентилях ожидать не стоит

## Профилирование

Проведем профилирование путем использования библиотеки async-profiler. Обсуловимся выполнять этап
параллельно с нагрузочным тестированием со следующими хар-ки:
* 16 соединений
* 1 поток
* 30 секунд
* 20000 RPS

Для GET запросов - БД наполнена

Для async-profiler:
* 30 секунд


### Результат профилирования по CPU на вставку данных

[Click me](profiling/putCpu.html)  

Заметим, что теперь операция flush находится в отдельном столбце у корня которого находится, Thread.run,
связанно это с тем, что flush вызывается в отдельном потоке, что бы не блокировать сервер. Вспомним, что
на прошлом стейдже операция занимала у нас 43% времени работы программы, теперь имеем 26%, возможность
обрабатывать больше запросов за меньший latency. Также интерес представляют несколько операций записи, которые
по своей сущности делают системный вызов. Эта часть будет оптимизирована мною в следующем стейдже.

### Результат профилирования по CPU на получение данных:

[Click me](profiling/getCpu.html)  

Функциональные составляющие получения данных из БД занимают очевидно кол-во программного времени.
Можно привести аналогичный анализ как и в первом стейдже

### Результат профилирования по Allocation на получение данных:

[Click me](profiling/getAlloc.html)

Получаем схожую картину как и в прошлом стейдже,что и стоило ожидать

### Результат профилирования по Allocation на вставку данных:

[Click me](profiling/putAlloc.html)

В данном графе можно заметить, новый столбец, который обознает аллокации в нашем ExecutorService, картина
вполне ожидаемая,на аллокацию во флаше приходится 4% программного времени

### Результат профилирования по Lock на вставку данных:
[Click me](profiling/putLock.html)

Можем заметить, что найдено было всего 3 сэмпла и говорит это нам о том, что практически идеально
была выполнена манипуляция потоками.

### Результат профилирования по Lock на получение данных:
[Click me](profiling/getLock.html)

Локи отсутствуют.







