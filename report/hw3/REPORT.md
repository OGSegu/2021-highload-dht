# Этап 3. Асинхронность

## Нагрузочное тестирование

Проведем нагрузочное тестирование с помощью wrk2. В качестве параметров возьмем следующие значения:
* **64 соединения**
* 1 поток
* 30 секунд
* 20000 RPS

**Выполним тестирование PUT запросам**, содержимое которого, описано в скрипте [put.lua](../hw1/scripts/put.lua)
```bash
wrk2 -c 64 -t 1 -d 30s -R 20000 --latency -s put.lua http://localhost:8080
```

Результаты:
```bash
 Running 30s test @ http://localhost:8080
  1 threads and 64 connections
  Thread calibration: mean lat.: 1.634ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.60ms  741.33us   8.69ms   68.05%
    Req/Sec    21.07k     2.11k   32.56k    73.77%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.51ms
 75.000%    2.07ms
 90.000%    2.58ms
 99.000%    3.49ms
 99.900%    6.08ms
 99.990%    7.85ms
 99.999%    8.49ms
100.000%    8.69ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.120     0.000000            1         1.00
       0.725     0.100000        39455         1.11
       0.940     0.200000        78882         1.25
       1.135     0.300000       118252         1.43
       1.321     0.400000       157572         1.67
       1.506     0.500000       196913         2.00
       1.605     0.550000       216655         2.22
       1.707     0.600000       236236         2.50
       1.816     0.650000       255849         2.86
       1.939     0.700000       275652         3.33
       2.073     0.750000       295362         4.00
       2.143     0.775000       305306         4.44
       2.217     0.800000       315087         5.00
       2.295     0.825000       324984         5.71
       2.379     0.850000       334762         6.67
       2.473     0.875000       344464         8.00
       2.525     0.887500       349376         8.89
       2.583     0.900000       354420        10.00
       2.643     0.912500       359231        11.43
       2.711     0.925000       364172        13.33
       2.789     0.937500       369150        16.00
       2.831     0.943750       371568        17.78
       2.875     0.950000       373940        20.00
       2.925     0.956250       376444        22.86
       2.979     0.962500       378895        26.67
       3.039     0.968750       381352        32.00
       3.075     0.971875       382583        35.56
       3.113     0.975000       383778        40.00
       3.157     0.978125       385023        45.71
       3.211     0.981250       386269        53.33
       3.277     0.984375       387461        64.00
       3.321     0.985938       388082        71.11
       3.377     0.987500       388701        80.00
       3.445     0.989062       389315        91.43
       3.525     0.990625       389921       106.67
       3.633     0.992188       390537       128.00
       3.699     0.992969       390846       142.22
       3.769     0.993750       391156       160.00
       3.861     0.994531       391461       182.86
       3.971     0.995313       391766       213.33
       4.163     0.996094       392076       256.00
       4.335     0.996484       392228       284.44
       4.523     0.996875       392382       320.00
       4.727     0.997266       392535       365.71
       4.951     0.997656       392692       426.67
       5.203     0.998047       392846       512.00
       5.379     0.998242       392921       568.89
       5.523     0.998437       392996       640.00
       5.711     0.998633       393073       731.43
       5.879     0.998828       393151       853.33
       6.115     0.999023       393227      1024.00
       6.271     0.999121       393267      1137.78
       6.391     0.999219       393305      1280.00
       6.547     0.999316       393342      1462.86
       6.719     0.999414       393383      1706.67
       6.819     0.999512       393419      2048.00
       6.903     0.999561       393440      2275.56
       6.967     0.999609       393458      2560.00
       7.047     0.999658       393477      2925.71
       7.103     0.999707       393497      3413.33
       7.275     0.999756       393515      4096.00
       7.431     0.999780       393527      4551.11
       7.507     0.999805       393535      5120.00
       7.619     0.999829       393545      5851.43
       7.683     0.999854       393554      6826.67
       7.759     0.999878       393563      8192.00
       7.815     0.999890       393568      9102.22
       7.859     0.999902       393573     10240.00
       7.903     0.999915       393578     11702.86
       7.983     0.999927       393583     13653.33
       8.043     0.999939       393587     16384.00
       8.079     0.999945       393590     18204.44
       8.123     0.999951       393593     20480.00
       8.135     0.999957       393595     23405.71
       8.263     0.999963       393597     27306.67
       8.303     0.999969       393599     32768.00
       8.327     0.999973       393601     36408.89
       8.343     0.999976       393602     40960.00
       8.375     0.999979       393605     46811.43
       8.375     0.999982       393605     54613.33
       8.375     0.999985       393605     65536.00
       8.471     0.999986       393606     72817.78
       8.487     0.999988       393607     81920.00
       8.487     0.999989       393607     93622.86
       8.503     0.999991       393608    109226.67
       8.503     0.999992       393608    131072.00
       8.511     0.999993       393609    145635.56
       8.511     0.999994       393609    163840.00
       8.511     0.999995       393609    187245.71
       8.567     0.999995       393610    218453.33
       8.567     0.999996       393610    262144.00
       8.567     0.999997       393610    291271.11
       8.567     0.999997       393610    327680.00
       8.567     0.999997       393610    374491.43
       8.695     0.999998       393611    436906.67
       8.695     1.000000       393611          inf
#[Mean    =        1.600, StdDeviation   =        0.741]
#[Max     =        8.688, Total count    =       393611]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  596883 requests in 30.00s, 38.14MB read
Requests/sec:  19894.40
Transfer/sec:      1.27MB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.51мс
* "Хвостовые" время ожидания (p999, p9999, p99999) = 6.08мс, 7.85мс, 8.49мс соответственно

На данном этапе мы выполняли нагрузочное тестирование в 64 соединения и как мы можем заметить по
персентилям, наш сервер способен стабильно обрабатывать подобное кол-во запросов.
Также мы теперь можем более гибко конфигурировать максимальное кол-во запросов для обработки нашем сервером.
Получить более подробную картину оптимизаций будет возможно при помощи профилирования.

**Выполним тестирование GET запросом**, содержимое которого, описано в скрипте [get.lua](../hw1/scripts/get.lua)

Будут использованы аналогичные хар-ки, как и в случае с PUT запросом.
Наша БД предварительно заполнена более чем на 300к+ записей

```bash
wrk2 -c 64 -t 1 -d 30s -R 20000 --latency -s get.lua http://localhost:8080
```

Результаты:
```bash
Running 2m test @ http://localhost:8080
  1 threads and 64 connections
\  Thread calibration: mean lat.: 1.557ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.60ms    0.97ms  24.35ms   84.16%
    Req/Sec    21.05k     2.23k   59.67k    76.66%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.47ms
 75.000%    2.04ms
 90.000%    2.54ms
 99.000%    3.63ms
 99.900%   13.36ms
 99.990%   20.66ms
 99.999%   23.25ms
100.000%   24.37ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.109     0.000000            1         1.00
       0.715     0.100000       219463         1.11
       0.915     0.200000       439301         1.25
       1.098     0.300000       658735         1.43
       1.283     0.400000       877810         1.67
       1.471     0.500000      1097081         2.00
       1.571     0.550000      1207348         2.22
       1.675     0.600000      1316372         2.50
       1.787     0.650000      1426676         2.86
       1.907     0.700000      1536252         3.33
       2.035     0.750000      1645202         4.00
       2.105     0.775000      1700450         4.44
       2.179     0.800000      1755907         5.00
       2.257     0.825000      1810558         5.71
       2.341     0.850000      1864885         6.67
       2.433     0.875000      1919408         8.00
       2.483     0.887500      1947149         8.89
       2.535     0.900000      1974236        10.00
       2.593     0.912500      2002241        11.43
       2.657     0.925000      2029577        13.33
       2.731     0.937500      2056689        16.00
       2.775     0.943750      2070563        17.78
       2.823     0.950000      2084113        20.00
       2.879     0.956250      2097974        22.86
       2.943     0.962500      2111596        26.67
       3.015     0.968750      2125105        32.00
       3.057     0.971875      2132026        35.56
       3.103     0.975000      2139007        40.00
       3.153     0.978125      2145636        45.71
       3.215     0.981250      2152505        53.33
       3.301     0.984375      2159360        64.00
       3.359     0.985938      2162819        71.11
       3.439     0.987500      2166209        80.00
       3.547     0.989062      2169604        91.43
       3.709     0.990625      2173030       106.67
       3.945     0.992188      2176456       128.00
       4.227     0.992969      2178172       142.22
       4.703     0.993750      2179880       160.00
       5.239     0.994531      2181590       182.86
       5.995     0.995313      2183306       213.33
       7.011     0.996094      2185019       256.00
       7.523     0.996484      2185871       284.44
       8.087     0.996875      2186731       320.00
       8.703     0.997266      2187589       365.71
       9.375     0.997656      2188441       426.67
      10.239     0.998047      2189302       512.00
      10.751     0.998242      2189735       568.89
      11.263     0.998437      2190160       640.00
      11.975     0.998633      2190587       731.43
      12.655     0.998828      2191021       853.33
      13.431     0.999023      2191440      1024.00
      13.855     0.999121      2191656      1137.78
      14.287     0.999219      2191873      1280.00
      14.743     0.999316      2192085      1462.86
      15.191     0.999414      2192297      1706.67
      15.839     0.999512      2192514      2048.00
      16.183     0.999561      2192622      2275.56
      16.623     0.999609      2192728      2560.00
      16.975     0.999658      2192834      2925.71
      17.775     0.999707      2192943      3413.33
      18.431     0.999756      2193050      4096.00
      18.687     0.999780      2193101      4551.11
      19.023     0.999805      2193155      5120.00
      19.503     0.999829      2193209      5851.43
      19.935     0.999854      2193261      6826.67
      20.335     0.999878      2193317      8192.00
      20.479     0.999890      2193343      9102.22
      20.671     0.999902      2193369     10240.00
      20.959     0.999915      2193396     11702.86
      21.279     0.999927      2193423     13653.33
      21.615     0.999939      2193451     16384.00
      21.711     0.999945      2193462     18204.44
      21.823     0.999951      2193476     20480.00
      21.903     0.999957      2193490     23405.71
      22.127     0.999963      2193502     27306.67
      22.287     0.999969      2193516     32768.00
      22.415     0.999973      2193523     36408.89
      22.511     0.999976      2193529     40960.00
      22.607     0.999979      2193536     46811.43
      22.719     0.999982      2193542     54613.33
      22.895     0.999985      2193549     65536.00
      22.975     0.999986      2193554     72817.78
      23.039     0.999988      2193556     81920.00
      23.135     0.999989      2193559     93622.86
      23.263     0.999991      2193562    109226.67
      23.327     0.999992      2193566    131072.00
      23.343     0.999993      2193568    145635.56
      23.375     0.999994      2193569    163840.00
      23.439     0.999995      2193571    187245.71
      23.455     0.999995      2193573    218453.33
      23.487     0.999996      2193574    262144.00
      23.775     0.999997      2193575    291271.11
      24.127     0.999997      2193576    327680.00
      24.143     0.999997      2193577    374491.43
      24.143     0.999998      2193577    436906.67
      24.175     0.999998      2193578    524288.00
      24.239     0.999998      2193579    582542.22
      24.239     0.999998      2193579    655360.00
      24.335     0.999999      2193580    748982.86
      24.335     0.999999      2193580    873813.33
      24.335     0.999999      2193580   1048576.00
      24.351     0.999999      2193581   1165084.44
      24.351     0.999999      2193581   1310720.00
      24.351     0.999999      2193581   1497965.71
      24.351     0.999999      2193581   1747626.67
      24.351     1.000000      2193581   2097152.00
      24.367     1.000000      2193582   2330168.89
      24.367     1.000000      2193582          inf
#[Mean    =        1.599, StdDeviation   =        0.967]
#[Max     =       24.352, Total count    =      2193582]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2396836 requests in 2.00m, 153.15MB read
Requests/sec:  19973.62
Transfer/sec:      1.28MB
```

**Проанализируем результаты.**

Интерес представляют следующие полученные характеристики:
* Медиана (p50) = 1.47мс
* "Хвостовые" время ожидания (p999, p9999, p99999) = 13.36мс, 20.66мс, 23.25мс соответственно

Можем лишь заметить, что наш сервер способен обрабатывать большое кол-во GET запросов.

## Профилирование

Проведем профилирование путем использования библиотеки async-profiler. Обсуловимся выполнять этап
параллельно с нагрузочным тестированием со следующими хар-ки:
* 64 соединений
* 1 поток
* 20000 RPS

Для GET запросов - БД наполнена

Для async-profiler:
* 30 секунд


### Результат профилирования по CPU на вставку данных

[Click me](profiling/cpuput.html)  

Заметим, что теперь все столбцы так или иначе начинаются с Thread.run, что логично, ведь теперь каждый запрос
выполняется в отдельном потоке.

### Результат профилирования по CPU на получение данных:

[Click me](profiling/cpuget.html)  

Аналогичная ситуцаия происходит и с GET запросами, они отрабатывают в отдельном потоке.

### Результат профилирования по Allocation на получение данных:

[Click me](profiling/allocget.html)

Изменения только на аллокацию потока.

### Результат профилирования по Allocation на вставку данных:

[Click me](profiling/allocput.html)

Изменения только на аллокацию потока.

### Результат профилирования по Lock на вставку данных:
[Click me](profiling/lockput.html)

Самая интересная часть. Так как теперь наш поток неявно проходит через блокирующую очередь экзекьютера, логично, что
теперь на каждый запрос у нас имеется блокировка, именно поэтому FlameGraph показывает 100%.

### Результат профилирования по Lock на получение данных:
[Click me](profiling/lockget.html)

Аналогичная ситуация, что и с lockput







